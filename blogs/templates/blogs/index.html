{% extends "base.html" %}

{% block content %}

<style>
    /* æ ‡é¢˜æ ·å¼ */
    .page-title {
        text-align: center;
        color: var(--grass-green);
        margin-bottom: 30px;
        font-size: 2rem;
        text-shadow: 2px 2px var(--cyan-light);
    }

    /* --- å¡ç‰‡æ ·å¼ --- */
    .post-card {
        background-color: var(--white);
        border-radius: 20px;
        border: 4px dashed var(--mint-light); 
        padding: 25px;
        margin-bottom: 25px;
        position: relative;
        box-shadow: 0 5px 0 rgba(152, 251, 152, 0.5);
        opacity: 0;
        transform: translateY(50px);
        animation: slideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        transition: all 0.3s;
    }

    .post-card:hover {
        border-color: var(--grass-green);
        box-shadow: 0 8px 0 rgba(50, 205, 50, 0.3);
        transform: translateY(-3px);
    }

    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

    .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .card-title {
        color: var(--dark-green);
        font-size: 1.4rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-meta {
        font-size: 0.85rem;
        color: #669;
        background: var(--cyan-light);
        padding: 4px 12px;
        border-radius: 15px;
        margin-bottom: 15px;
        display: inline-block;
    }

    .card-text { line-height: 1.6; color: #555; }

    /* --- æŒ‰é’®ç»„ --- */
    .card-actions {
        margin-top: 15px;
        border-top: 2px dotted #eee;
        padding-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-read-more {
        background: linear-gradient(to bottom, #fff, var(--mint-bg));
        border: 2px solid var(--mint-light);
        border-radius: 50px;
        color: var(--grass-green);
        padding: 8px 20px;
        cursor: pointer;
        font-family: var(--font-cute);
        font-weight: bold;
        transition: all 0.2s;
    }
    .btn-read-more:hover { background: var(--mint-light); color: white; }

    /* --- ç‚¹èµä¸è®¡æ•° --- */
    .interaction-box { display: flex; gap: 15px; align-items: center; }
    
    .like-btn {
        background: none; border: none; cursor: pointer;
        font-size: 1.5rem; color: #ccc;
        transition: transform 0.2s;
        display: flex; align-items: center; gap: 5px;
    }
    .like-btn:hover { transform: scale(1.2); }
    .like-btn.liked { color: var(--grass-green); animation: pulse 0.5s; }
    
    .count-text {
        font-size: 0.9rem; color: var(--grass-green); font-weight: bold;
    }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

    /* --- ğŸ†• æ¨¡æ€æ¡†å†…éƒ¨æ ·å¼ --- */
    .modal-window {
        background: white;
        width: 90%; max-width: 600px; max-height: 80vh;
        border-radius: 25px;
        border: 5px solid var(--mint-light);
        display: flex; flex-direction: column;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .modal-header {
        padding: 15px 20px;
        border-bottom: 2px dashed #eee;
        display: flex; justify-content: space-between; align-items: center;
        background: var(--mint-bg);
        border-radius: 20px 20px 0 0;
    }
    .btn-close {
        background: none; border: none; font-size: 1.5rem; color: #ff8888; cursor: pointer;
        transition: transform 0.2s;
    }
    .btn-close:hover { transform: rotate(90deg) scale(1.1); }

    .modal-body {
        padding: 20px;
        overflow-y: auto; /* å†…å®¹æ»šåŠ¨ */
        line-height: 1.8;
        color: #444;
    }

    .modal-footer {
        padding: 20px;
        background: #f9fdf9;
        border-top: 2px dashed #eee;
        border-radius: 0 0 20px 20px;
    }
    
    /* æ¨¡æ‹Ÿè¯„è®ºåŒº */
    .comment-item { font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .comment-user { color: var(--grass-green); font-weight: bold; }
    .comment-input {
        width: 100%; padding: 10px; border-radius: 10px; border: 2px solid var(--mint-light);
        font-family: var(--font-cute); margin-top: 10px;
    }
</style>

<h2 class="page-title">ğŸƒ è™šç©ºçŸ¥è¯†åº“ ğŸƒ</h2>

{% for post in posts %}
    <!-- 1. å¤–å±‚å¡ç‰‡ -->
    <div class="post-card" style="animation-delay: calc({{ forloop.counter }} * 100ms);">
        <div class="card-header-row">
            <h3 class="card-title">ğŸŒ¿ {{ post.title }}</h3>
            {% if user == post.author %}
                <a href="{% url 'blogs:edit_blog' post.id %}" style="font-size:0.9rem; text-decoration:none;">âœï¸</a>
            {% endif %}
        </div>
        
        <div class="card-meta">
            ğŸ‘¤ {{ post.author.username }} &nbsp;|&nbsp; ğŸ•’ {{ post.date_added|date:"Y-m-d" }}
        </div>
        
        <!-- æ‘˜è¦å±•ç¤ºï¼ˆæˆªæ–­æ–‡æœ¬ï¼‰ -->
        <div class="card-text">
            {{ post.text|linebreaks|truncatechars:80 }}
        </div>

        <div class="card-actions">
            <!-- æŸ¥çœ‹å…¨æ–‡æŒ‰é’® -->
            <button class="btn-read-more" onclick="showModal('post-{{ post.id }}')">
                ğŸ¬ æŸ¥çœ‹å…¨æ–‡
            </button>

            <!-- äº’åŠ¨åŒºåŸŸ -->
            <div class="interaction-box">
                <!-- ç‚¹èµ (çº¯å‰ç«¯äº¤äº’æ¼”ç¤º) -->
                <button class="like-btn" onclick="toggleLike(this)">
                    <span>ğŸ‘</span> <span class="count-text">12</span>
                </button>
                <div class="count-text">ğŸ’¬ 3</div>
            </div>
        </div>
    </div>

    <!-- 2. éšè—çš„æ¨¡æ€æ¡† (æ¯ä¸ªå¸–å­å¯¹åº”ä¸€ä¸ª) -->
    <div id="modal-post-{{ post.id }}" class="modal-overlay" onclick="closeModal(event, 'post-{{ post.id }}')">
        <!-- é˜»æ­¢ç‚¹å‡»çª—å£å†…å®¹æ—¶å…³é—­ -->
        <div class="modal-window" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 style="color:var(--dark-green)">{{ post.title }}</h3>
                <button class="btn-close" onclick="closeModalDirect('post-{{ post.id }}')">âœ–ï¸</button>
            </div>
            
            <div class="modal-body">
                <p style="color:#888; font-size:0.8rem; margin-bottom:15px;">
                    å‘å¸ƒäº: {{ post.date_added|date:"Y-m-d H:i" }} | ä½œè€…: {{ post.author.username }}
                </p>
                <!-- å®Œæ•´å†…å®¹ -->
                {{ post.text|linebreaks }}
            </div>

            <div class="modal-footer">
                <h5 style="color:var(--grass-green); margin-bottom:10px;">ğŸ’¬ è¯„è®ºåŒº (3)</h5>
                <!-- é™æ€æ¨¡æ‹Ÿè¯„è®º -->
                <div class="comment-item">
                    <span class="comment-user">æ´¾è’™:</span> å“‡ï¼Œè¿™å°±æ˜¯æ–°çš„çŸ¥è¯†å—ï¼
                </div>
                <div class="comment-item">
                    <span class="comment-user">æ—…è¡Œè€…:</span> è®°å½•å¾—å¾ˆè¯¦ç»†å‘¢ã€‚
                </div>
                
                {% if user.is_authenticated %}
                    <input type="text" class="comment-input" placeholder="è¾“å…¥è¯„è®ºï¼Œå›è½¦å‘é€..." />
                {% else %}
                    <p style="font-size:0.8rem; color:#999;">è¯· <a href="{% url 'login' %}">ç™»å½•</a> åå‘è¡¨è¯„è®ºã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>

{% empty %}
    <div style="text-align:center; padding:50px; color:#888;">ğŸ‚ çŸ¥è¯†åº“æš‚æ—¶ç©ºç©ºå¦‚ä¹Ÿ...</div>
{% endfor %}

<!-- 3. åŸç”Ÿ JavaScript äº¤äº’é€»è¾‘ -->
<script>
    // æ˜¾ç¤ºå¼¹çª—
    function showModal(id) {
        const modal = document.getElementById('modal-' + id);
        modal.style.display = 'flex';
        // ç¨å¾®å»¶æ—¶åŠ activeç±»ä»¥è§¦å‘é€æ˜åº¦åŠ¨ç”»
        setTimeout(() => modal.classList.add('active'), 10);
        document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
    }

    // å…³é—­å¼¹çª—ï¼ˆç‚¹å‡»é®ç½©å±‚ï¼‰
    function closeModal(event, id) {
        if (event.target.classList.contains('modal-overlay')) {
            closeModalDirect(id);
        }
    }

    // å…³é—­å¼¹çª—ï¼ˆç›´æ¥è°ƒç”¨ï¼‰
    function closeModalDirect(id) {
        const modal = document.getElementById('modal-' + id);
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // æ¢å¤æ»šåŠ¨
        }, 300); // ç­‰åŠ¨ç”»ç»“æŸ
    }

    // ç‚¹èµåŠ¨ç”»é€»è¾‘
    function toggleLike(btn) {
        // åˆ‡æ¢ liked ç±»
        btn.classList.toggle('liked');
        
        // è·å–æ•°å­—span
        const countSpan = btn.querySelector('.count-text');
        let count = parseInt(countSpan.innerText);
        
        if (btn.classList.contains('liked')) {
            countSpan.innerText = count + 1;
            btn.querySelector('span').innerText = "ğŸ’š"; // å˜å¿ƒ
        } else {
            countSpan.innerText = count - 1;
            btn.querySelector('span').innerText = "ğŸ‘"; // å˜å›
        }
    }
</script>

{% endblock content %}